
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>1.7 lifecycle · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../part2_bucket/" />
    
    
    <link rel="prev" href="6.rgw_dns_name.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../readme.html">
            
                <a href="../readme.html">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../part1_object_object/README.md">
            
                <span>
            
                    
                    第一章:对象及其元数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="1.put_object.html">
            
                <a href="1.put_object.html">
            
                    
                    1.1 对象上传与其元数据管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="2.copy_object.html">
            
                <a href="2.copy_object.html">
            
                    
                    1.2 CopyObject
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="3.post_object.html">
            
                <a href="3.post_object.html">
            
                    
                    1.3 表单上传对象
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="4.scrub.html">
            
                <a href="4.scrub.html">
            
                    
                    1.4 scrub
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="5.SSE.html">
            
                <a href="5.SSE.html">
            
                    
                    1.5 服务器加密SSE
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="6.rgw_dns_name.html">
            
                <a href="6.rgw_dns_name.html">
            
                    
                    1.6 rgw_dns_name
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.7" data-path="7.lifecycle.html">
            
                <a href="7.lifecycle.html">
            
                    
                    1.7 lifecycle
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../part2_bucket/">
            
                <a href="../part2_bucket/">
            
                    
                    第二章:桶及其元数据
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../part2_bucket/1.list_bucket.html">
            
                <a href="../part2_bucket/1.list_bucket.html">
            
                    
                    2.1 list bucket的实现
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../part3_access_control_access_control/README.md">
            
                <span>
            
                    
                    第三章:桶与对象的权限管理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../part3_access_control/1.bucket_acl_object_acl.html">
            
                <a href="../part3_access_control/1.bucket_acl_object_acl.html">
            
                    
                    3.1 ACL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../part3_access_control/2.bucket_policy.html">
            
                <a href="../part3_access_control/2.bucket_policy.html">
            
                    
                    3.2 Policy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../part3_access_control/3.sts.html">
            
                <a href="../part3_access_control/3.sts.html">
            
                    
                    3.3 STS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../part4_monitor/">
            
                <a href="../part4_monitor/">
            
                    
                    第四章:集群监控
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../part5_rados/">
            
                <a href="../part5_rados/">
            
                    
                    第五章:PG到OSD
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../part5_rados/1.crush.html">
            
                <a href="../part5_rados/1.crush.html">
            
                    
                    5.1 CRUSH算法
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >1.7 lifecycle</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="17-lifecycle">1.7 lifecycle</h1>
<h2 id="&#x53C2;&#x8003;">&#x53C2;&#x8003;</h2>
<p><a href="https://www.jianshu.com/p/8c7054386c4e" target="_blank">ceph rgw&#xFF1A;lifecycle&#x5B9E;&#x73B0;</a></p>
<p><a href="https://github.com/ceph/ceph/pull/13385" target="_blank">rgw: add support for noncurrentversion expiration in s3 lifecycle</a></p>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/intro-lifecycle-rules.html" target="_blank">aws :Lifecycle configuration elements</a></p>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/how-to-set-lifecycle-configuration-intro.html" target="_blank">aws: Setting lifecycle configuration on a bucket</a></p>
<p><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lifecycle-mgmt.html" target="_blank">aws: Managing your storage lifecycle</a></p>
<p><a href="https://www.suse.com/c/move-objects-between-storage-classes-using-s3-bucket-lifecycle-management/" target="_blank">suse: Move objects between Storage Classes using S3 Bucket Lifecycle Management</a></p>
<h2 id="aws-&#x89C4;&#x8303;">aws &#x89C4;&#x8303;</h2>
<h3 id="removing-expired-object-delete-markers">Removing expired object delete markers</h3>
<p>NoncurrentVersionExpiration&#x53EA;&#x4F1A;&#x5E94;&#x7528;&#x4E8E;&#x201D;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&quot;&#x3002;&#x4E0B;&#x9762;&#x914D;&#x7F6E;&#x53EA;&#x4F1A;&#x5E94;&#x7528;&#x4E8E;&#x5BF9;&#x8C61;&#x53D8;&#x4E3A;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;30&#x5929;&#x540E;&#xFF0C;&#x5C06;&#x4F1A;&#x5220;&#x9664;&#x8FD9;&#x4E9B;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LifecycleConfiguration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Rule</span>&gt;</span>
        ...
        <span class="hljs-tag">&lt;<span class="hljs-name">NoncurrentVersionExpiration</span>&gt;</span>     
            <span class="hljs-tag">&lt;<span class="hljs-name">NoncurrentDays</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">NoncurrentDays</span>&gt;</span>    
        <span class="hljs-tag">&lt;/<span class="hljs-name">NoncurrentVersionExpiration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rule</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LifecycleConfiguration</span>&gt;</span>
</code></pre>
<p>&#x5BF9;&#x4E8E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x7684;&#x5904;&#x7406;&#xFF0C;&#x9700;&#x8981;&#x8003;&#x8651;&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x662F;&#x5426;&#x9075;&#x5FAA;well-defined lifecycle&#xFF1A;</p>
<ol>
<li>&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x9075;&#x5FAA;well-defined lifecycle</li>
</ol>
<p>&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Expiration&#x6765;&#x5220;&#x9664;&#x5F53;&#x524D;&#x7248;&#x672C;&#x5BF9;&#x8C61;&#xFF1A;&#x5982;&#x4E0B;&#x914D;&#x7F6E;&#x5C06;&#x5728;&#x8BE5;&#x5BF9;&#x8C61;&#x88AB;&#x521B;&#x5EFA;60&#x5929;&#x4EE5;&#x540E;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x4E2D;&#x6DFB;&#x52A0;delete marker&#x6765;&#x5220;&#x9664;&#x5F53;&#x524D;&#x7248;&#x672C;&#x3002;(&#x8FD9;&#x6837;&#x4F1A;&#x4F7F;&#x5F53;&#x524D;&#x7248;&#x672C;&#x53D8;&#x4E3A;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#xFF0C;&#x5E76;&#x4F7F;&#x5F97;delete marker&#x53D8;&#x4E3A;&#x5F53;&#x524D;&#x7248;&#x672C;&#x3002;)&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x5F53;&#x524D;&#x7248;&#x672C;&#x53D8;&#x4E3A;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x7684;30&#x5929;&#x540E;&#xFF0C;&#x5220;&#x9664;&#x8FD9;&#x4E9B;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LifecycleConfiguration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Rule</span>&gt;</span>
        ...
        <span class="hljs-tag">&lt;<span class="hljs-name">Expiration</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">Days</span>&gt;</span>60<span class="hljs-tag">&lt;/<span class="hljs-name">Days</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Expiration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">NoncurrentVersionExpiration</span>&gt;</span>     
            <span class="hljs-tag">&lt;<span class="hljs-name">NoncurrentDays</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">NoncurrentDays</span>&gt;</span>    
        <span class="hljs-tag">&lt;/<span class="hljs-name">NoncurrentVersionExpiration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rule</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LifecycleConfiguration</span>&gt;</span>
</code></pre>
<blockquote>
<p>You cannot specify both a <code>Days</code> and <code>ExpiredObjectDeleteMarker</code> tag on the same rule. Specifying the <code>Days</code> tag will automatically perform <code>ExpiredObjectDeleteMarker</code> cleanup once delete markers are old enough to satisfy the age criteria. You can create a separate rule with only the <code>ExpiredObjectDeleteMarker</code> tag to clean up delete markers as soon as they become the only version.</p>
</blockquote>
<ol>
<li>&#x5F53;&#x524D;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x4E0D;&#x9075;&#x5FAA;well-defined lifecycle</li>
</ol>
<p>&#x9700;&#x8981;&#x624B;&#x52A8;&#x53BB;&#x79FB;&#x9664;&#x4E0D;&#x9700;&#x8981;&#x7684;&#x5BF9;&#x8C61;&#xFF08;&#x5373;&#x624B;&#x52A8;&#x4E0D;&#x6307;&#x5B9A;version-id&#x5220;&#x9664;&#x5BF9;&#x8C61;&#xFF0C;&#x4EE5;&#x751F;&#x6210;&#x8BE5;&#x5BF9;&#x8C61;&#x7684;delete marker&#xFF09;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">LifecycleConfiguration</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Rule</span>&gt;</span>
       <span class="hljs-tag">&lt;<span class="hljs-name">ID</span>&gt;</span>Rule 1<span class="hljs-tag">&lt;/<span class="hljs-name">ID</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Filter</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Prefix</span>&gt;</span>logs/<span class="hljs-tag">&lt;/<span class="hljs-name">Prefix</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Status</span>&gt;</span>Enabled<span class="hljs-tag">&lt;/<span class="hljs-name">Status</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Expiration</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">ExpiredObjectDeleteMarker</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">ExpiredObjectDeleteMarker</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Expiration</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">NoncurrentVersionExpiration</span>&gt;</span>     
            <span class="hljs-tag">&lt;<span class="hljs-name">NoncurrentDays</span>&gt;</span>30<span class="hljs-tag">&lt;/<span class="hljs-name">NoncurrentDays</span>&gt;</span>    
        <span class="hljs-tag">&lt;/<span class="hljs-name">NoncurrentVersionExpiration</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Rule</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">LifecycleConfiguration</span>&gt;</span>
</code></pre>
<p>&#x901A;&#x8FC7;&#x6DFB;&#x52A0;ExpiredObjectDeleteMarker&#x4E3A;true&#xFF0C;&#x53EF;&#x4EE5;&#x79FB;&#x9664;expired object delete markers&#x3002;(&#x5373;)</p>
<blockquote>
<p>When specifying the <code>ExpiredObjectDeleteMarker</code> Lifecycle action, the rule cannot specify a tag-based filter.</p>
</blockquote>
<h2 id="lifecycle&#x4F53;&#x9A8C;&#xFF08;&#x4F7F;&#x7528;l&#x7248;&#x6216;n&#x7248;&#x7ED3;&#x679C;&#x76F8;&#x540C;&#xFF09;">lifecycle&#x4F53;&#x9A8C;&#xFF08;&#x4F7F;&#x7528;L&#x7248;&#x6216;N&#x7248;&#x7ED3;&#x679C;&#x76F8;&#x540C;&#xFF09;</h2>
<p>&#x8BBE;&#x7F6E;&#x4E86;rgw_lc_debug_interval=10&#xFF0C;&#x56E0;&#x6B64;&#x5C06;&#x4EE5;10s&#x4F5C;&#x4E3A;1&#x5929;&#x3002;</p>
<pre><code class="lang-shell">function demo_versioning_lc_expire_deletemarker(){
    enable_bucket_versioning $BUCKET
    get_bucket_versioning $BUCKET
    put_bucket_lifecycle_configuration_expire $BUCKET lc_expiration_versioning.json
    get_bucket_lifecycle_configureation $BUCKET
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    list_object_versions $BUCKET
}
</code></pre>
<h1 id="&#x5F00;&#x542F;bucket-versioning&#x8BBE;&#x7F6E;lifecycle&#x4E3A;&#x9488;&#x5BF9;prefix&#x4E3A;object&#x7684;&#x5BF9;&#x8C61;&#xFF0C;2&#x5929;&#x540E;&#x5220;&#x9664;&#x5BF9;&#x8C61;&#xFF0C;1&#x5929;&#x540E;&#x5220;&#x9664;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x7684;&#x5BF9;&#x8C61;&#x3002;">&#x5F00;&#x542F;bucket versioning,&#x8BBE;&#x7F6E;lifecycle&#x4E3A;&#x9488;&#x5BF9;prefix&#x4E3A;object&#x7684;&#x5BF9;&#x8C61;&#xFF0C;2&#x5929;&#x540E;&#x5220;&#x9664;&#x5BF9;&#x8C61;&#xFF0C;1&#x5929;&#x540E;&#x5220;&#x9664;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x7684;&#x5BF9;&#x8C61;&#x3002;</h1>
<p>&#x6B64;&#x5904;&#x7684;Expiration&#x8868;&#x793A;&#x4E0D;&#x6307;&#x5B9A;version-id&#x5220;&#x9664;&#xFF0C;&#x5373;&#x751F;&#x6210;isLatest=true&#x7684;deletemarker&#x3002;&#x5904;&#x7406;&#x540E;get-object&#x5C06;&#x65E0;&#x6CD5;&#x83B7;&#x5F97;&#x8BE5;&#x5BF9;&#x8C61;&#xFF1B;</p>
<p>NoncurrentVersionExpiration&#x8868;&#x793A;&#x5220;&#x9664;&#x975E;&#x5F53;&#x524D;&#x7248;&#x672C;&#x5BF9;&#x8C61;&#xFF0C;&#x5373;&#x6307;&#x5B9A;version-id&#x5220;&#x9664;&#x3002;</p>
<blockquote>
<p>The <code>NoncurrentVersionExpiration</code> action in the same Lifecycle configuration removes noncurrent objects 30 days after they become noncurrent. Thus, in this example, all object versions are permanently removed 90 days after object creation. You will have expired object delete markers, but Amazon S3 detects and removes the expired object delete markers for you&#x3002;<a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/lifecycle-configuration-examples.html#lifecycle-config-conceptual-ex6" target="_blank">&#x53C2;&#x8003;</a></p>
<p>&#x5373;&#x5982;&#x4E0B;&#x8FD9;&#x6837;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;2&#x5929;&#x540E;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;delete marker&#xFF0C;&#x5E76;&#x5C06;&#x6240;&#x6709;&#x7684;&#x5BF9;&#x8C61;&#x53D8;&#x4E3A;NoncurrentVersion&#xFF0C;&#x7136;&#x540E;&#x518D;&#x53D8;&#x4E3A;&#x8BE5;&#x72B6;&#x6001;&#x7684;1&#x5929;&#x540E;&#xFF0C;&#x5C06;&#x5176;&#x6E05;&#x9664;&#x3002;&#x7136;&#x540E;&#x5269;&#x4E0B;&#x7684;delete marker&#x5C06;&#x7531;ceph&#x81EA;&#x884C;&#x5220;&#x9664;&#x3002;--&gt; TODO:&#x4EE3;&#x7801;&#x5982;&#x4F55;&#x5B9E;&#x73B0;&#x81EA;&#x52A8;&#x5220;&#x9664;&#xFF1F;</p>
</blockquote>
<p>&#x9009;&#x53D6;&#x90E8;&#x5206;&#x7ED3;&#x679C;&#x5C55;&#x793A;&#xFF1A;</p>
<h3 id="&#x5148;&#x5F00;&#x542F;versioning&#xFF0C;&#x518D;&#x4E0A;&#x4F20;&#x7684;&#x60C5;&#x51B5;">&#x5148;&#x5F00;&#x542F;versioning&#xFF0C;&#x518D;&#x4E0A;&#x4F20;&#x7684;&#x60C5;&#x51B5;</h3>
<pre><code class="lang-shell">function demo_versioning_lc_expire_deletemarker(){
    delete_bucket $BUCKET
    create_bucket $BUCKET
    put_bucket_versioning_enabled $BUCKET
    get_bucket_versioning $BUCKET
    put_bucket_lifecycle_configuration_expire $BUCKET lc_expiration_versioning.json
    get_bucket_lifecycle_configureation $BUCKET
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    list_object_versions $BUCKET
}

[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
#1. bucket versioning&#x662F;&#x5F00;&#x542F;&#x7684;&#xFF1A;
{
    &quot;Status&quot;: &quot;Enabled&quot;,
    &quot;MFADelete&quot;: &quot;Disabled&quot;
}
#2. &#x8BBE;&#x7F6E;lifecycle&#xFF0C;&#x5BF9;&#x4E8E;prefix&#x4E3A;object&#x7684;&#x5BF9;&#x8C61;&#xFF0C;2&#x5929;&#x540E;&#x5220;&#x9664;&#xFF08;&#x8BBE;&#x7F6E;deletemarker&#xFF0C;&#x5C06;&#x539F;&#x6709;&#x5BF9;&#x8C61;&#x7248;&#x672C;IsLatest&#x8BBE;&#x7F6E;&#x4E3A;false&#xFF0C;&#x53D8;&#x4E3A;Noncurrent&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x76F8;&#x5E94;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x4ECE;&#x53D8;&#x4E3A;Noncurrent&#x5F00;&#x59CB;&#x7684;2&#x5929;&#x540E;&#x5220;&#x9664;&#x8BE5;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#xFF08;&#x5B9E;&#x9645;&#x7684;&#x5220;&#x9664;&#xFF09;&#x3002;

{
    &quot;Rules&quot;: [
        {
            &quot;Expiration&quot;: {
                &quot;Days&quot;: 2
            },
            &quot;ID&quot;: &quot;lc_expiration_versioning&quot;,
            &quot;Filter&quot;: {
                &quot;Prefix&quot;: &quot;object&quot;
            },
            &quot;Status&quot;: &quot;Enabled&quot;,
            &quot;NoncurrentVersionExpiration&quot;: {
                &quot;NoncurrentDays&quot;: 2
            }
        }
    ]
}
put_obj: bucket0/object0
{
    &quot;Expiration&quot;: &quot;expiry-date=\&quot;Mon, 27 Sep 2021 14:21:48 GMT\&quot;, rule-id=\&quot;lc_expiration_versioning\&quot;&quot;,
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;lKViTZn6BUEyfBir8.WHBpju3mEm8s-&quot;
}
put_obj: bucket0/object0
{
    &quot;Expiration&quot;: &quot;expiry-date=\&quot;Mon, 27 Sep 2021 14:21:49 GMT\&quot;, rule-id=\&quot;lc_expiration_versioning\&quot;&quot;,
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;a5ZYHEjA5gJ1E-6akCTU0D4HVFLxKOt&quot;
}
put_obj: bucket0/object0
{
    &quot;Expiration&quot;: &quot;expiry-date=\&quot;Mon, 27 Sep 2021 14:21:51 GMT\&quot;, rule-id=\&quot;lc_expiration_versioning\&quot;&quot;,
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;dv2Ok656Szgp8Jz.m33TYy4Fjj4DfoC&quot;
}
{
    &quot;Versions&quot;: [
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;dv2Ok656Szgp8Jz.m33TYy4Fjj4DfoC&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-25T14:21:51.146000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        },
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;a5ZYHEjA5gJ1E-6akCTU0D4HVFLxKOt&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-25T14:21:49.457000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        },
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;lKViTZn6BUEyfBir8.WHBpju3mEm8s-&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-25T14:21:48.235000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        }
    ]
}
# &#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x6765;&#x6709;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x4E0E;delete marker&#x4E00;&#x540C;&#x5B58;&#x5728;&#xFF0C;&#x800C;&#x5176;&#x4ED6;&#x4E24;&#x4E2A;&#x7248;&#x672C;&#x7684;&#x5BF9;&#x8C61;&#x5DF2;&#x7ECF;&#x88AB;&#x5220;&#x9664;&#x4E86;&#x3002;
# &#x8FD9;&#x662F;&#x56E0;&#x4E3A;&#x4E00;&#x5F00;&#x59CB;&#x540C;&#x65F6;&#xFF08;&#x51E0;&#x4E4E;&#xFF09;&#x521B;&#x5EFA;&#x7684;&#x5176;&#x4ED6;2&#x4E2A;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x4E00;&#x5F00;&#x59CB;&#x5C31;&#x662F;Noncurrent&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x6BD4;&#x8F83;&#x65E9;&#x5C31;&#x88AB;&#x5220;&#x9664;&#x4E86;&#xFF0C;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x4E00;&#x5F00;&#x59CB;&#x662F;Current&#x7684;&#xFF0C;&#x5728;2&#x5929;&#x540E;&#x624D;&#x901A;&#x8FC7;Expiration&#x8BBE;&#x7F6E;&#x4E3A;Noncurrent&#x7684;&#xFF0C;&#x56E0;&#x6B64;&#x73B0;&#x5728;&#x8FD8;&#x5B58;&#x5728;&#x3002;&#x5B9E;&#x9645;&#x4E0A;&#x7ECF;&#x8FC7;&#x4E86;4&#x5929;&#x624D;&#x4F1A;&#x88AB;&#x5220;&#x9664;&#x3002;
[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
{
    &quot;Versions&quot;: [
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;dv2Ok656Szgp8Jz.m33TYy4Fjj4DfoC&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-25T14:21:51.146000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        }
    ],
    &quot;DeleteMarkers&quot;: [
        {
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            },
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;ao05OibisXC0aa8858BoUnAwOBjGpdC&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-25T14:22:13.307000+00:00&quot;
        }
    ]
}
# &#x6240;&#x6709;&#x7684;Noncurrent&#x5BF9;&#x8C61;&#x90FD;&#x88AB;&#x5220;&#x9664;&#x4E86;&#xFF0C;&#x53EA;&#x5269;&#x4E0B;&#x4E86;delete marker
[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
{
    &quot;DeleteMarkers&quot;: [
        {
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            },
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;ao05OibisXC0aa8858BoUnAwOBjGpdC&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-25T14:22:13.307000+00:00&quot;
        }
    ]
}

[Done] exited with code=0 in 3.196 seconds

# delete marker&#x4E5F;&#x88AB;&#x5220;&#x9664;&#x4E86;
[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;

[Done] exited with code=0 in 2.899 seconds
</code></pre>
<h3 id="&#x5728;versioning&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x6709;&#x5BF9;&#x8C61;&#x4E0A;&#x4F20;&#x7684;&#x60C5;&#x51B5;&#xFF1A;">&#x5728;versioning&#x4E4B;&#x524D;&#x5DF2;&#x7ECF;&#x6709;&#x5BF9;&#x8C61;&#x4E0A;&#x4F20;&#x7684;&#x60C5;&#x51B5;&#xFF1A;</h3>
<pre><code class="lang-shell">function demo_versioning_lc_expire_deletemarker_after(){
    delete_bucket $BUCKET
    create_bucket $BUCKET
    put_object $BUCKET $OBJECT
    put_bucket_versioning_enabled $BUCKET
    get_bucket_versioning $BUCKET
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    put_bucket_lifecycle_configuration_expire $BUCKET lc_expiration_versioning.json
    get_bucket_lifecycle_configureation $BUCKET
    list_object_versions $BUCKET
}

[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
create bucket0
put_obj: bucket0/object0
{
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;
}
{
    &quot;Status&quot;: &quot;Enabled&quot;,
    &quot;MFADelete&quot;: &quot;Disabled&quot;
}
put_obj: bucket0/object0
{
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;vyDbAGmjejTlGkhAJLwRvKaPxfxDOnh&quot;
}
put_obj: bucket0/object0
{
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;vmn-YFIbivCp10JKCoCujIOup9APBIm&quot;
}
{
    &quot;Rules&quot;: [
        {
            &quot;Expiration&quot;: {
                &quot;Days&quot;: 2
            },
            &quot;ID&quot;: &quot;lc_expiration_versioning&quot;,
            &quot;Prefix&quot;: &quot;&quot;,
            &quot;Status&quot;: &quot;Enabled&quot;,
            &quot;NoncurrentVersionExpiration&quot;: {
                &quot;NoncurrentDays&quot;: 2
            }
        }
    ]
}
{
    &quot;Versions&quot;: [
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;vmn-YFIbivCp10JKCoCujIOup9APBIm&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-25T14:47:56.629000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        },
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;vyDbAGmjejTlGkhAJLwRvKaPxfxDOnh&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-25T14:47:54.997000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        },
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;null&quot;, #&#x6CE8;&#x610F;&#x6B64;&#x5904;&#xFF0C;&#x67E5;&#x770B;&#x5BF9;&#x8C61;&#x7248;&#x672C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x8FD9;&#x4E2A;&#x5728;&#x5F00;&#x542F;versioning&#x4E4B;&#x524D;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;versionid=null
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-25T14:47:50.988000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        }
    ]
}

[Done] exited with code=0 in 17.457 seconds
# &#x53EF;&#x4EE5;&#x770B;&#x5230;version-id=null&#x7684;&#x5BF9;&#x8C61;&#x4E5F;&#x88AB;&#x8BA4;&#x4E3A;&#x666E;&#x901A;&#x7684;NoncurrentVersion&#x5BF9;&#x8C61;&#x88AB;&#x5220;&#x9664;
[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
{
    &quot;Versions&quot;: [
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;vmn-YFIbivCp10JKCoCujIOup9APBIm&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-25T14:47:56.629000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        },
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;vyDbAGmjejTlGkhAJLwRvKaPxfxDOnh&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-25T14:47:54.997000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        }
    ]
}

[Done] exited with code=0 in 3.158 seconds

[Running] /bin/bash &quot;/Users/sinjoywong/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;

[Done] exited with code=0 in 2.43 seconds
</code></pre>
<h3 id="&#x81EA;&#x52A8;&#x5220;&#x9664;&#x8FC7;&#x671F;delete-marker&#x7684;&#x60C5;&#x51B5;">&#x81EA;&#x52A8;&#x5220;&#x9664;&#x8FC7;&#x671F;delete marker&#x7684;&#x60C5;&#x51B5;</h3>
<pre><code class="lang-shell">function demo_versioning_lc_expire_deletemarker_manual(){
    delete_bucket $BUCKET
    create_bucket $BUCKET
    put_bucket_versioning_enabled $BUCKET
    get_bucket_versioning $BUCKET
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    put_object $BUCKET $OBJECT
    delete_object $BUCKET $OBJECT
    put_bucket_lifecycle_configuration_expire $BUCKET lc_expiration_version_manual.json
    get_bucket_lifecycle_configureation $BUCKET
    list_object_versions $BUCKET
}

[Running] /bin/bash &quot;/Users/shelocwang/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
delete_bucket: bucket0
create bucket0
{
    &quot;Status&quot;: &quot;Enabled&quot;
}
put_obj: bucket0/object0
{
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;S55uZDV2ZZS0vC2vdrV02ORCke6qpov&quot;
}
put_obj: bucket0/object0
{
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;Y1vgiUtj5FHpYaMN5YEOHVu3l86elPy&quot;
}
put_obj: bucket0/object0
{
    &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
    &quot;VersionId&quot;: &quot;SFCbK0MnrF7l0.PmPFevRv8H29gbaVw&quot;
}
delete_obj bucket0/object0
{
    &quot;DeleteMarker&quot;: true,
    &quot;VersionId&quot;: &quot;0gAdArNXwkgt2zmACXSL174TrHSqYHW&quot;
}
{
    &quot;Rules&quot;: [
        {
            &quot;Expiration&quot;: {
                &quot;ExpiredObjectDeleteMarker&quot;: true
            },
            &quot;ID&quot;: &quot;lc_expiration_versioning_manual&quot;,
            &quot;Filter&quot;: {
                &quot;Prefix&quot;: &quot;object&quot;
            },
            &quot;Status&quot;: &quot;Enabled&quot;,
            &quot;NoncurrentVersionExpiration&quot;: {
                &quot;NoncurrentDays&quot;: 1
            }
        }
    ]
}
{
    &quot;Versions&quot;: [
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;SFCbK0MnrF7l0.PmPFevRv8H29gbaVw&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-26T02:26:56.882000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        }
    ],
    &quot;DeleteMarkers&quot;: [
        {
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            },
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;0gAdArNXwkgt2zmACXSL174TrHSqYHW&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-26T02:26:59.635000+00:00&quot;
        }
    ]
}
{
    &quot;Versions&quot;: [
        {
            &quot;ETag&quot;: &quot;\&quot;d41d8cd98f00b204e9800998ecf8427e\&quot;&quot;,
            &quot;Size&quot;: 0,
            &quot;StorageClass&quot;: &quot;STANDARD&quot;,
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;SFCbK0MnrF7l0.PmPFevRv8H29gbaVw&quot;,
            &quot;IsLatest&quot;: false,
            &quot;LastModified&quot;: &quot;2021-09-26T02:26:56.882000+00:00&quot;,
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            }
        }
    ],
    &quot;DeleteMarkers&quot;: [
        {
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            },
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;0gAdArNXwkgt2zmACXSL174TrHSqYHW&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-26T02:26:59.635000+00:00&quot;
        }
    ]
}

[Done] exited with code=0 in 32.997 seconds

[Running] /bin/bash &quot;/Users/shelocwang/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;
{
    &quot;DeleteMarkers&quot;: [
        {
            &quot;Owner&quot;: {
                &quot;DisplayName&quot;: &quot;M. Tester&quot;,
                &quot;ID&quot;: &quot;testid&quot;
            },
            &quot;Key&quot;: &quot;object0&quot;,
            &quot;VersionId&quot;: &quot;0gAdArNXwkgt2zmACXSL174TrHSqYHW&quot;,
            &quot;IsLatest&quot;: true,
            &quot;LastModified&quot;: &quot;2021-09-26T02:26:59.635000+00:00&quot;
        }
    ]
}

[Done] exited with code=0 in 2.77 seconds


[Running] /bin/bash &quot;/Users/shelocwang/Documents/DevDocumentsPersonal/&#x9644;&#x4EF6;_Codes/ceph_demo_lc.sh&quot;

[Done] exited with code=0 in 2.756 seconds
</code></pre>
<h2 id="ceph&#x5B9E;&#x73B0;lifecycle">ceph&#x5B9E;&#x73B0;Lifecycle</h2>
<p>&#x8C03;&#x8BD5;&#x53C2;&#x6570;&#xFF1A;rgw_lc_debug_interval&#xFF0C;&#x8BE5;&#x503C;&#x5355;&#x4F4D;&#x4E3A;s&#xFF0C;&#x8868;&#x793A;&#x4EE5;&#x591A;&#x5C11;&#x79D2;&#x4E3A;&#x4E00;&#x5929;</p>
<p>RGWLC&#x7C7B;&#x662F;&#x8D1F;&#x8D23;&#x6267;&#x884C;lc&#x7684;&#x7C7B;&#xFF0C;&#x5B83;&#x4F1A;&#x6839;&#x636E;&#x7528;&#x6237;&#x7684;&#x914D;&#x7F6E;&#x5F00;&#x542F;1&#x4E2A;&#x6216;&#x591A;&#x4E2A;worker&#x7EBF;&#x7A0B;&#xFF0C;&#x8FD9;&#x4E9B;worker&#x7EBF;&#x7A0B;&#x7684;&#x4EFB;&#x52A1;&#x662F;&#x5728;&#x4E00;&#x4E2A;&#x65E0;&#x9650;&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;&#x6BCF;&#x9694;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x5224;&#x65AD;&#x4E00;&#x4E0B;&#x5F53;&#x524D;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x6267;&#x884C;lifecycle&#x7684;&#x904D;&#x5386;&#x5DE5;&#x4F5C;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x8C03;&#x7528;RGWLC&#x7C7B;&#x7684;process&#x65B9;&#x6CD5;&#xFF0C;&#x968F;&#x673A;&#x9009;&#x62E9;32&#x4E2A;lc.xx&#x5BF9;&#x8C61;&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#xFF0C;&#x6839;&#x636E;&#x5176;header&#x4E2D;&#x7684;&#x6807;&#x8BB0;&#xFF0C;&#x53D6;&#x51FA;&#x5176;&#x672A;&#x904D;&#x5386;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;omap entry&#xFF0C;&#x66F4;&#x65B0;header&#x4E2D;&#x7684;&#x6807;&#x8BB0;&#xFF0C;&#x66F4;&#x65B0;&#x8BE5;entry&#x7684;&#x72B6;&#x6001;&#x4E3A;processing&#xFF0C;&#x7136;&#x540E;&#x5904;&#x7406;&#x8BE5;entry&#xFF0C;&#x904D;&#x5386;&#x8BE5;&#x6761;entry&#x5BF9;&#x5E94;&#x7684;bucket&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5BF9;&#x8C61;&#xFF0C;&#x6839;&#x636E;lc&#x89C4;&#x5219;&#x5220;&#x9664;&#x6216;&#x8F6C;&#x6362;bucket&#x4E2D;&#x8FC7;&#x671F;&#x7684;object&#xFF0C;&#x5E76;&#x5199;&#x65E5;&#x5FD7;&#x3002;</p>
<p>&#x4EE3;&#x7801;&#x8FFD;&#x8E2A;&#x5982;&#x4E0B;&#xFF1A;</p>
<p>&#x4E0B;&#x9762;&#x8FD9;&#x4E2A;&#x51FD;&#x6570;&#x662F;worker&#x7EBF;&#x7A0B;&#x7684;&#x7684;&#x6267;&#x884C;&#x5185;&#x5BB9;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x5B83;&#x5728;&#x4E00;&#x4E2A;while&#x5FAA;&#x73AF;&#x4E2D;&#xFF0C;&#x6BCF;&#x9694;&#x4E00;&#x6BB5;&#x65F6;&#x95F4;&#x5224;&#x65AD;should_work&#xFF0C;&#x5982;&#x679C;&#x901A;&#x8FC7;&#x7684;&#x8BDD;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x8C03;&#x7528;lc-&gt;process()&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x904D;&#x5386;&#xFF0C;&#x7136;&#x540E;&#x8BBE;&#x7F6E;&#x4E0B;&#x4E00;&#x6B21;&#x88AB;&#x5524;&#x9192;&#x7684;&#x65F6;&#x95F4;&#xFF0C;&#x8FDB;&#x5165;&#x963B;&#x585E;&#x72B6;&#x6001;&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">void</span> *RGWLC::LCWorker::entry() {
  <span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">utime_t</span> start = ceph_clock_now();
    <span class="hljs-keyword">if</span> (should_work(start)) {
      dout(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;life cycle: start&quot;</span> &lt;&lt; dendl;
      <span class="hljs-keyword">int</span> r = lc-&gt;process();
      <span class="hljs-keyword">if</span> (r &lt; <span class="hljs-number">0</span>) {
        dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;ERROR: do life cycle process() returned error r=&quot;</span> &lt;&lt; r &lt;&lt; dendl;
      }
      dout(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;life cycle: stop&quot;</span> &lt;&lt; dendl;
    }
    <span class="hljs-keyword">if</span> (lc-&gt;going_down())
      <span class="hljs-keyword">break</span>;

    <span class="hljs-keyword">utime_t</span> end = ceph_clock_now();
    <span class="hljs-keyword">int</span> secs = schedule_next_start_time(start, end);
    <span class="hljs-keyword">utime_t</span> next;
    next.set_from_double(end + secs);

    dout(<span class="hljs-number">5</span>) &lt;&lt; <span class="hljs-string">&quot;schedule life cycle next start time: &quot;</span> &lt;&lt; rgw_to_asctime(next) &lt;&lt;dendl;

    lock.Lock();
    cond.WaitInterval(lock, <span class="hljs-keyword">utime_t</span>(secs, <span class="hljs-number">0</span>));
    lock.Unlock();
  } <span class="hljs-keyword">while</span> (!lc-&gt;going_down());

  <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;
}
</code></pre>
<p>&#x5728;RGWLC::process&#x51FD;&#x6570;&#x4E2D;&#xFF0C;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4EE5;&#x4E0B;&#x51E0;&#x4EF6;&#x4E8B;&#xFF1A;
1.&#x4ECE;lc.xx&#x5BF9;&#x8C61;&#x7684;header&#x4E2D;&#x83B7;&#x5F97;omap&#x4E2D;&#x8981;&#x904D;&#x5386;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;entry
2.&#x5C06;&#x62FF;&#x5230;&#x7684;entry&#x7684;&#x72B6;&#x6001;&#x8BBE;&#x4E3A;processing&#xFF08;&#x6B63;&#x5728;&#x5904;&#x7406;&#xFF09;
3.&#x66F4;&#x65B0;header&#x4E2D;&#x8BB0;&#x5F55;&#x7684;&#x4E0B;&#x4E00;&#x4E2A;entry
4.&#x8C03;&#x7528;<code>bucket_lc_process</code>&#x51FD;&#x6570;&#x5904;&#x7406;&#x5F53;&#x524D;&#x7684;entry&#x5BF9;&#x5E94;&#x7684;lc&#x89C4;&#x5219;</p>
<p><code>bucket_lc_process</code>&#xFF1A;&#x904D;&#x5386;&#x67D0;&#x6761;lc&#x89C4;&#x5219;&#x5BF9;&#x5E94;&#x7684;bucket&#x7684;&#x6240;&#x6709;objects&#xFF0C;&#x6839;&#x636E;prefix&#x548C;tagging&#x627E;&#x5230;lc &#x89C4;&#x5219;&#x4F5C;&#x7528;&#x7684;object&#xFF0C;&#x7136;&#x540E;&#x5224;&#x65AD;&#x8FD9;&#x4E9B;objects&#x662F;&#x5426;&#x8FC7;&#x671F;&#xFF0C;&#x5982;&#x679C;&#x8FC7;&#x671F;&#xFF0C;&#x505A;&#x5BF9;&#x5E94;&#x7684;&#x5220;&#x9664;&#x5904;&#x7406;&#x3002;</p>
<p>&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x76EE;&#x524D;L&#x7248;&#x672C;&#x7684;ceph&#x4EC5;&#x652F;&#x6301;&#x5230;&#x671F;&#x5220;&#x9664;&#x7684;lifecycle&#xFF0C;&#x4E5F;&#x5C31;&#x662F;Expiration&#x3002;&#x4E0D;&#x652F;&#x6301;Transition&#x3002;</p>
<pre><code class="lang-c++"><span class="hljs-keyword">int</span> RGWLC::process(<span class="hljs-keyword">int</span> index, <span class="hljs-keyword">int</span> max_lock_secs)
{
  rados::cls::lock::<span class="hljs-function">Lock <span class="hljs-title">l</span><span class="hljs-params">(lc_index_lock_name)</span></span>;
  <span class="hljs-keyword">do</span> {
    <span class="hljs-keyword">utime_t</span> now = ceph_clock_now();
    pair&lt;<span class="hljs-built_in">string</span>, <span class="hljs-keyword">int</span> &gt; entry;<span class="hljs-comment">//string = bucket_name:bucket_id ,int = LC_BUCKET_STATUS</span>
    <span class="hljs-keyword">if</span> (max_lock_secs &lt;= <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> -EAGAIN;

    <span class="hljs-keyword">utime_t</span> time(max_lock_secs, <span class="hljs-number">0</span>);
    l.set_duration(time);

    <span class="hljs-keyword">int</span> ret = l.lock_exclusive(&amp;store-&gt;lc_pool_ctx, obj_names[index]);
    <span class="hljs-keyword">if</span> (ret == -EBUSY) { <span class="hljs-comment">/* already locked by another lc processor */</span>
      dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;RGWLC::process() failed to acquire lock on, sleep 5, try again&quot;</span> &lt;&lt; obj_names[index] &lt;&lt; dendl;
      sleep(<span class="hljs-number">5</span>);
      <span class="hljs-keyword">continue</span>;
    }
    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>)
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;

    <span class="hljs-built_in">string</span> marker;
    cls_rgw_lc_obj_head head;
    ret = cls_rgw_lc_get_head(store-&gt;lc_pool_ctx, obj_names[index], head);
    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
      dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;RGWLC::process() failed to get obj head &quot;</span> &lt;&lt; obj_names[index] &lt;&lt; ret &lt;&lt; dendl;
      <span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;
    }

    <span class="hljs-keyword">if</span>(!if_already_run_today(head.start_date)) {
      head.start_date = now;
      head.marker.clear();
      ret = bucket_lc_prepare(index);
      <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
      dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;RGWLC::process() failed to update lc object &quot;</span> &lt;&lt; obj_names[index] &lt;&lt; ret &lt;&lt; dendl;
      <span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;
      }
    }

    ret = cls_rgw_lc_get_next_entry(store-&gt;lc_pool_ctx, obj_names[index], head.marker, entry);
    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
      dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;RGWLC::process() failed to get obj entry &quot;</span> &lt;&lt; obj_names[index] &lt;&lt; dendl;
      <span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;
    }

    <span class="hljs-keyword">if</span> (entry.first.empty())
      <span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;

    entry.second = lc_processing;
    ret = cls_rgw_lc_set_entry(store-&gt;lc_pool_ctx, obj_names[index],  entry);
    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
      dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;RGWLC::process() failed to set obj entry &quot;</span> &lt;&lt; obj_names[index] &lt;&lt; entry.first &lt;&lt; entry.second &lt;&lt; dendl;
      <span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;
    }

    head.marker = entry.first;
    ret = cls_rgw_lc_put_head(store-&gt;lc_pool_ctx, obj_names[index],  head);
    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
      dout(<span class="hljs-number">0</span>) &lt;&lt; <span class="hljs-string">&quot;RGWLC::process() failed to put head &quot;</span> &lt;&lt; obj_names[index] &lt;&lt; dendl;
      <span class="hljs-keyword">goto</span> <span class="hljs-built_in">exit</span>;
    }
    l.unlock(&amp;store-&gt;lc_pool_ctx, obj_names[index]);
    ret = bucket_lc_process(entry.first);
    bucket_lc_post(index, max_lock_secs, entry, ret);
  }<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>);

<span class="hljs-built_in">exit</span>:
    l.unlock(&amp;store-&gt;lc_pool_ctx, obj_names[index]);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="6.rgw_dns_name.html" class="navigation navigation-prev " aria-label="Previous page: 1.6 rgw_dns_name">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../part2_bucket/" class="navigation navigation-next " aria-label="Next page: 第二章:桶及其元数据">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"1.7 lifecycle","level":"1.3.7","depth":2,"next":{"title":"第二章:桶及其元数据","level":"1.4","depth":1,"path":"part2_bucket/README.md","ref":"part2_bucket/README.md","articles":[{"title":"2.1 list bucket的实现","level":"1.4.1","depth":2,"path":"part2_bucket/1.list_bucket.md","ref":"part2_bucket/1.list_bucket.md","articles":[]}]},"previous":{"title":"1.6 rgw_dns_name","level":"1.3.6","depth":2,"path":"part1_object/6.rgw_dns_name.md","ref":"part1_object/6.rgw_dns_name.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"part1_object/7.lifecycle.md","mtime":"2022-04-10T09:30:58.086Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2022-04-10T10:00:41.682Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

